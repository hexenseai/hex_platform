{% extends 'profilebase.html' %}
{% load static %}

{% block content %}
<div class="space-y-8">
    <!-- User Info Section -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">User Information</h2>
        <div class="grid grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-medium text-gray-400">Full Name</label>
                <p class="text-gray-200" id="user-name"></p>
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400">Email</label>
                <p class="text-gray-200" id="user-email"></p>
            </div>
        </div>
    </div>

    <!-- Password Change Section -->
    <div class="bg-gray-800 rounded-lg p-6">
        <h2 class="text-xl font-semibold mb-4">Change Password</h2>
        <form id="password-form" class="space-y-4">
            <div>
                <label class="block text-sm font-medium text-gray-400">Current Password</label>
                <input type="password" name="current_password" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400">New Password</label>
                <input type="password" name="new_password" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white">
            </div>
            <div>
                <label class="block text-sm font-medium text-gray-400">Confirm New Password</label>
                <input type="password" name="confirm_password" class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white">
            </div>
            <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                Change Password
            </button>
        </form>
    </div>

    <!-- Profiles Section -->
    <div id="profiles-container" class="space-y-6">
        <!-- Profiles will be loaded here dynamically -->
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Load user info
    fetch('/api/whoami/')
        .then(response => response.json())
        .then(data => {
            document.getElementById('user-name').textContent = `${data.first_name} ${data.last_name}`;
            document.getElementById('user-email').textContent = data.email;
            document.getElementById('user-fullname').textContent = `${data.first_name} ${data.last_name}`;
        });

    // Load profiles
    fetch('/userprofile/', {
        headers: {
            'X-Requested-With': 'XMLHttpRequest'
        }
    })
        .then(response => response.json())
        .then(profiles => {
            const container = document.getElementById('profiles-container');
            profiles.forEach(profile => {
                const profileElement = createProfileElement(profile);
                container.appendChild(profileElement);
            });
        });

    function createProfileElement(profile) {
        const div = document.createElement('div');
        div.className = 'bg-gray-800 rounded-lg p-6';
        div.innerHTML = `
            <h3 class="text-lg font-semibold mb-4">${profile.company ? profile.company.name : 'No Company'} - ${profile.role ? profile.role.name : 'No Role'}</h3>
            <form class="profile-form space-y-4" data-profile-id="${profile.id}">
                <div>
                    <label class="block text-sm font-medium text-gray-400">Phone Number</label>
                    <input type="text" name="phone_number" value="${profile.phone_number || ''}" 
                           class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400">GPT Preferences</label>
                    <textarea name="gpt_preferences" rows="3" 
                              class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white">${profile.gpt_preferences || ''}</textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-400">Work Experience Notes</label>
                    <textarea name="work_experience_notes" rows="3" 
                              class="mt-1 block w-full rounded-md bg-gray-700 border-gray-600 text-white">${profile.work_experience_notes || ''}</textarea>
                </div>
                <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">
                    Update Profile
                </button>
            </form>
        `;

        // Add form submission handler
        div.querySelector('form').addEventListener('submit', function(e) {
            e.preventDefault();
            const profileId = this.dataset.profileId;
            const formData = new FormData(this);
            
            fetch(`/userprofile/${profileId}/`, {
                method: 'PATCH',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify(Object.fromEntries(formData))
            })
            .then(response => {
                if (response.ok) {
                    alert('Profile updated successfully');
                } else {
                    alert('Failed to update profile');
                }
            });
        });

        return div;
    }

    // Password form submission
    document.getElementById('password-form').addEventListener('submit', function(e) {
        e.preventDefault();
        // Add password change logic here
    });

    // Helper function to get CSRF token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}
